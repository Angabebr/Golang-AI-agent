package agent

import (
	"context"
	"strings"

	"github.com/Angabebr/Golang-AI-agent/ai"
	"github.com/Angabebr/Golang-AI-agent/browser"
)

// SubAgentType определяет тип специализированного агента
type SubAgentType string

const (
	SubAgentEmail    SubAgentType = "email"
	SubAgentShopping SubAgentType = "shopping"
	SubAgentJob      SubAgentType = "job"
	SubAgentGeneric  SubAgentType = "generic"
)

// SubAgent представляет специализированного агента для конкретной задачи
type SubAgent struct {
	agentType SubAgentType
	browser   *browser.Browser
	aiClient  *ai.Client
	systemPrompt string
}

// NewSubAgent создает нового специализированного агента
func NewSubAgent(agentType SubAgentType, browser *browser.Browser, aiClient *ai.Client) *SubAgent {
	subAgent := &SubAgent{
		agentType: agentType,
		browser:   browser,
		aiClient:  aiClient,
	}
	
	subAgent.systemPrompt = subAgent.getSystemPrompt()
	
	return subAgent
}

// getSystemPrompt возвращает системный промпт для типа агента
func (sa *SubAgent) getSystemPrompt() string {
	switch sa.agentType {
	case SubAgentEmail:
		return `Ты - специализированный AI-агент для работы с почтой.
Твоя задача - анализировать письма, определять спам и управлять почтовым ящиком.
Ты умеешь:
- Читать и анализировать письма
- Определять спам по признакам: рекламные рассылки, подозрительные отправители, фишинг
- Удалять спам-письма
- Предоставлять отчеты о проделанной работе
Работай автономно, принимай решения на основе содержимого страницы.`
		
	case SubAgentShopping:
		return `Ты - специализированный AI-агент для заказа еды и покупок.
Твоя задача - находить товары, добавлять их в корзину и оформлять заказы.

ВАЖНО: Ты РАБОТАЕШЬ с веб-сайтами через браузер. Это твоя основная функция - управлять браузером и выполнять действия на веб-страницах.

Ты умеешь:
- Переходить на сайты доставки еды и покупок (самокат, яндекс.еда и другие)
- Искать товары по названию (например, "филе индейки", "морс")
- Добавлять товары в корзину
- Оформлять заказы (останавливайся перед финальным подтверждением оплаты)
- Работать с корзиной

ВАЖНО ДЛЯ ПОИСКА ТОВАРОВ:
- Если поле поиска не найдено сразу, подожди 2-3 секунды - оно может загружаться динамически
- Если поле поиска скрыто за кнопкой, сначала кликни на кнопку поиска (иконка лупы, текст "Поиск" и т.д.)
- На сайтах доставки еды поле поиска может иметь разные названия: "искать", "поиск", "search", "найти товар" и т.д.
- Если не можешь найти поле поиска, попробуй кликнуть на иконку поиска или кнопку с текстом "Поиск"

КРИТИЧЕСКИ ВАЖНО:
- Ты ДОЛЖЕН работать с веб-сайтами - это твоя основная функция
- НЕ отказывайся от работы с веб-сайтами
- НЕ завершай задачу преждевременно - продолжай до полного выполнения
- Если нужно заказать несколько товаров - добавь все товары в корзину
- Работай автономно, анализируй страницы и принимай решения на основе текущего состояния`
		
	case SubAgentJob:
		return `Ты - специализированный AI-агент для поиска работы и отклика на вакансии.
Твоя задача - находить релевантные вакансии на веб-сайтах (например, hh.ru) и откликаться на них.

ВАЖНО: Ты РАБОТАЕШЬ с веб-сайтами через браузер. Это твоя основная функция - управлять браузером и выполнять действия на веб-страницах.

Ты умеешь:
- Переходить на сайты поиска работы (hh.ru и другие)
- Изучать профиль пользователя на сайте
- Искать подходящие вакансии через поиск
- Анализировать требования к вакансиям
- Составлять персонализированные сопроводительные письма на основе требований вакансии
- Откликаться на вакансии (нажимать кнопки "Откликнуться", заполнять формы)
- Заполнять поля сопроводительного письма

КРИТИЧЕСКИ ВАЖНО:
- Ты ДОЛЖЕН работать с веб-сайтами - это твоя основная функция
- НЕ отказывайся от работы с веб-сайтами
- НЕ завершай задачу преждевременно - продолжай до полного выполнения
- Если нужно откликнуться на 3 вакансии - откликнись на все 3, не останавливайся на одной
- Работай автономно, используй информацию из профиля и требований вакансии для персонализации сопроводительных писем`
		
	default:
		return `Ты - автономный AI-агент для выполнения веб-задач.
Работай автономно, анализируй страницы и принимай решения на основе текущего состояния.`
	}
}

// DetectSubAgentType определяет тип под-агента на основе задачи
func DetectSubAgentType(task string) SubAgentType {
	taskLower := strings.ToLower(task)
	
	// Сначала проверяем job-ключевые слова (более специфичные)
	// Важно: проверяем ПЕРЕД email, так как "письмо" может быть в "сопроводительное письмо"
	jobKeywords := []string{"ваканс", "vacancy", "job", "работа", "hh.ru", "hh", "резюме", "resume", "отклик", "откликнуться", "рекрутер"}
	for _, keyword := range jobKeywords {
		if strings.Contains(taskLower, keyword) {
			return SubAgentJob
		}
	}
	
	// Проверяем shopping-ключевые слова
	shoppingKeywords := []string{
		"заказ", "order", "купить", "buy", "корзин", "cart", "бургер", "еда", "food", "доставк",
		"самокат", "samokat", "яндекс.еда", "яндекс еда", "yandex.food", "delivery", "доставка",
		"яндекс лавка", "яндекс.лавка", "yandex.lavka", "лавка", "lavka",
		"филе", "индейк", "морс", "компот", "напиток", "drink", "товар", "product", "каталог",
		"меню", "menu", "ресторан", "restaurant", "кафе", "cafe", "пицца", "pizza", "суши", "sushi",
	}
	for _, keyword := range shoppingKeywords {
		if strings.Contains(taskLower, keyword) {
			return SubAgentShopping
		}
	}
	
	// Проверяем email-ключевые слова (последними, чтобы не перехватывать "письмо" из "сопроводительное письмо")
	// Используем более специфичные ключевые слова для email
	emailKeywords := []string{"почт", "email", "mail.ru", "e.mail.ru", "спам", "входящ", "почтовый ящик"}
	for _, keyword := range emailKeywords {
		if strings.Contains(taskLower, keyword) {
			return SubAgentEmail
		}
	}
	
	return SubAgentGeneric
}

// Execute выполняет задачу с использованием специализированного промпта
func (sa *SubAgent) Execute(ctx context.Context, task string, mainAgent *Agent) error {
	// Сохраняем оригинальный промпт и устанавливаем специализированный
	originalPrompt := sa.aiClient.GetSystemPrompt()
	// Добавляем общие инструкции по действиям
	actionsPrompt := `

Доступные действия:
1. navigate - перейти на URL
   - Можешь использовать URL из списка links.href ИЛИ указать прямой URL (например, "https://mail.ru", "https://e.mail.ru", "https://hh.ru")
   - Заполни: "url" (полный URL, можно прямой или из списка links)
   
2. click - кликнуть на элемент
   - ОБЯЗАТЕЛЬНО заполни: "text" (видимый текст из списка buttons или links)
   - Или если text не работает: "selector" (CSS селектор)
   
3. fill - заполнить поле ввода
   - ОБЯЗАТЕЛЬНО заполни: "text" (placeholder, name, aria-label из списка inputs)
   - ОБЯЗАТЕЛЬНО заполни: "value" (значение для ввода)
   - Для полей поиска можно использовать общие термины: "искать", "search", "поиск"
   - Для полей сопроводительного письма используй: "Сопроводительное письмо" или "письмо" в поле "text", а сам текст письма - в "value"
   - ВАЖНО: НЕ используй весь текст письма как placeholder! Используй короткий placeholder типа "Сопроводительное письмо", а сам текст - в "value"
   - Или если text не работает: "selector" (CSS селектор) + "value"
   
4. wait - подождать
   - Опционально: "wait_for" (селектор элемента)
   
5. extract - извлечь информацию (уже сделано автоматически)
6. complete - задача выполнена ТОЛЬКО когда задача действительно выполнена

КРИТИЧЕСКИ ВАЖНО - ПРАВИЛА ЗАПОЛНЕНИЯ ПОЛЕЙ:
- Для действия "navigate": Можешь использовать URL из списка links ИЛИ указать прямой URL (например, "https://mail.ru", "https://e.mail.ru", "https://hh.ru")
- Для действия "click": ВСЕГДА заполняй "text" из списка buttons/links
- Для действия "fill": ВСЕГДА заполняй "text" (из inputs.placeholder, inputs.name, inputs.aria-label) И "value"
- Для полей поиска можно использовать общие термины: "искать", "search", "поиск" - система найдет поле автоматически
- Для полей сопроводительного письма: используй "Сопроводительное письмо" или "письмо" в "text", а сам текст письма - в "value"
- КРИТИЧЕСКИ ВАЖНО: НЕ используй весь длинный текст письма как placeholder! Это приведет к поиску в неправильном месте
- НЕ завершай задачу (complete) если просто не можешь найти ссылку - используй navigate с прямым URL
- НЕ используй заготовленные селекторы - анализируй ТОЛЬКО данные текущей страницы
- НЕ отказывайся от работы с веб-сайтами - это твоя основная функция
- Если задача требует выполнить несколько действий (например, откликнуться на 3 вакансии) - выполни ВСЕ действия, не останавливайся на первом
- Отвечай ТОЛЬКО в формате JSON, без дополнительного текста до или после JSON

Формат ответа (строго валидный JSON):
{
  "action": "click|fill|navigate|wait|complete",
  "reasoning": "объяснение",
  "text": "текст элемента (для click/fill)",
  "selector": "CSS селектор (опционально)",
  "value": "значение (для fill)",
  "url": "URL (для navigate - можно прямой URL или из списка)",
  "wait_for": "селектор (для wait)",
  "is_complete": true/false,
  "summary": "резюме (при завершении)"
}`
	
	// Устанавливаем объединенный промпт
	sa.aiClient.SetSystemPrompt(sa.systemPrompt + actionsPrompt)
	
	// Восстанавливаем оригинальный промпт после выполнения
	defer sa.aiClient.SetSystemPrompt(originalPrompt)
	
	// Выполняем задачу через основной агент (который теперь использует специализированный промпт)
	return mainAgent.executeTask(ctx, task)
}

